#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  
#!!!!!!!! DO NOT EDIT THIS FILE !!!!!!!!
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  
#
# Please create a file called ~/.my_shell_complements and put your 
# speficic aliases/exports/functions/whatever there. Let's 
# keep this file essential!
#

# General Aliases
test alias cfg > /dev/null 2>&1 || alias cfg='/usr/bin/git --git-dir=$HOME/.cfg/ --work-tree=$HOME'
test alias up > /dev/null 2>&1 || alias up='up.sh'
test alias tmux > /dev/null 2>&1 || alias tmux='tmux -u2'
test alias clima > /dev/null 2>&1 || alias clima='curl v2.wttr.in'
test alias bye > /dev/null 2>&1 || alias bye='sudo shutdown -h now'

test alias .. >/dev/null 2>&1 || alias ..='cd ..'
test alias ps > /dev/null 2>&1 || alias ps='ps aux'
test alias cal > /dev/null 2>&1 || alias cal='cal -3'
test alias myip > /dev/null 2>&1 || alias myip='curl ipinfo.io/ip'
test alias net > /dev/null 2>&1 || alias net='netstat -tlnp'
test alias untar > /dev/null 2>&1 || alias untar='tar -zxvf'
test alias keygen >/dev/null 2>&1 || alias keygen='ssh-keygen -b 7168 -t rsa'

# Permite a extração do Dockerfile de uma determinada imagem
# exemplo de uso: dfimage -sV=1.36 nginx:latest
test alias dfimage > /dev/null 2>&1 || alias dfimage="docker run -v /var/run/docker.sock:/var/run/docker.sock --rm alpine/dfimage -sV=1.36"

#
# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
   test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"

   test alias ls >/dev/null 2>&1 || alias ls='ls --color=auto'
   
   test alias dir >/dev/null 2>&1 || alias dir='dir --color=auto'
   test alias vdir >/dev/null 2>&1 || alias vdir='vdir --color=auto'

   test alias grep >/dev/null 2>&1 || alias grep='grep --color=auto'
   test alias fgrep >/dev/null 2>&1 || alias fgrep='fgrep --color=auto'
   test alias egrep >/dev/null 2>&1 || alias egrep='egrep --color=auto'
fi
#
test alias la >/dev/null 2>&1 || alias la='ls -la'
test alias ll >/dev/null 2>&1 || alias ll='ls -l'
test alias l >/dev/null 2>&1 || alias l='ls -CF'

test alias wiki >/dev/null 2>&1 || alias wiki='cd $HOME/workspace/wiki && git pull && obsidian && git add --all && git commit -am "wiki updates (notebook)" && git push'
test alias info >/dev/null 2>&1 || alias info='informant --file $HOME/.cache/informant.dat'

##
# FUNCTIONS/APPS
##

# bottom - a better top
if command -v cargo >/dev/null 2>&1 > /dev/null; then
    if [ ! -f $HOME/.cargo/bin/btm ]; then
        cargo install -f --git https://github.com/ClementTsang/bottom bottom
    fi
    test alias oldtop >/dev/null 2>&1 || alias oldtop='/usr/bin/top'
    test alias top >/dev/null 2>&1 || alias top='btm --theme gruvbox'
fi

# Use lf to switch directories and bind it to ctrl-o
# Source: https://gist.github.com/LukeSmithxyz/e62f26e55ea8b0ed41a65912fbebbe52
lfcd () {
    
    if [ ! -f "$BIN_FOLDER/lf" ]; then
        BASEDIR=`pwd`
        cd $BIN_FOLDER

        file=lf-linux-amd64.tar.gz
        if [ "$OS" = "Darwin" ]; then
            file=lf-darwin-amd64.tar.gz
        fi 

        wget https://github.com/gokcehan/lf/releases/download/r14/$file
        tar -zxvf $file
        rm $file
        mkdir -p ~/.config/lf
        curl https://raw.githubusercontent.com/gokcehan/lf/master/etc/lfrc.example -o ~/.config/lf/lfrc
        cd $BASEDIR
    fi

    tmp="$(mktemp)"
    lf -last-dir-path="$tmp" "$@"
    if [ -f "$tmp" ]; then
        dir="$(cat "$tmp")"
        rm -f "$tmp"
        [ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
    fi
}
if command -v zsh >/dev/null; then
    bindkey -s '^o' 'lfcd\n'
    autoload -Uz tetriscurses
    test alias tetris > /dev/null 2>&1 || alias tetris='tetriscurses'
fi

# fetch (using treefetch, and change it to a christmas tree when time comes)
fetch() {

    if [ "$OS" = "Darwin" ]; then

        if [ ! -f "$BIN_FOLDER/pfetch"  ]; then
            BASEDIR=`pwd`
            cd /tmp

            wget https://github.com/dylanaraps/pfetch/archive/master.zip
            unzip master.zip
            install pfetch-master/pfetch $BIN_FOLDER/
            ls -l $BIN_FOLDER/pfetch

            cd $BASEDIR
        fi

        pfetch
        return 0
    fi

    if ! which treefetch &>/dev/null; then
        cargo install -f --git https://github.com/angelofallars/treefetch treefetch
    fi

    advent.sh # run the script to check if we are in advent
    advent_file=/tmp/advento.txt

    if [ ! -f $advent_file ]; then
        treefetch --bonsai
    else
        treefetch --xmas
    fi

}


gpg-enc() {
  local input_file="$1"
  local output_file="$2"
  local recipient

  if [[ -z "$input_file" || ! -f "$input_file" ]]; then
    echo "Uso: encrypt_file <arquivo> [arquivo_saida]"
    return 1
  fi

  output_file="${output_file:-${input_file}.gpg}"

  echo "Selecionando chave GPG..."
  gpg --list-keys --with-colons | awk -F: '/^uid:/ { print NR-1 ") " $10 }'
  read -p "Escolha o número da chave (acima): " idx
  recipient=$(gpg --list-keys --with-colons | awk -F: '/^uid:/ { print $10 }' | sed -n "$((idx+1))p")

  if [[ -z "$recipient" ]]; then
    echo "Chave inválida."
    return 1
  fi

  gpg -e -r "$recipient" -o "$output_file" "$input_file" && echo "✔ Encriptado com sucesso: $output_file"
}


gpg-dec() {
  local input_file="$1"
  local output_file="$2"

  if [[ -z "$input_file" || ! -f "$input_file" ]]; then
    echo "Uso: decrypt_file <arquivo.gpg> [arquivo_saida]"
    return 1
  fi

  output_file="${output_file:-${input_file%.gpg}}"

  gpg -d -o "$output_file" "$input_file" && echo "✔ Desencriptado com sucesso: $output_file"
}

aws-login() {

    if ! which aws &>/dev/null; then
	    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
	    cd /tmp
	    unzip awscliv2.zip
	    sudo ./aws/install
	    cd $HOME
    fi
    
    SSO_SESSION_NAME=""
    [ -z ${AWS_SSO_SESSION_NAME+x} ] || SSO_SESSION_NAME="--sso-session $AWS_SSO_SESSION_NAME"

    PROFILE=default
    [ -n "$1" ] && PROFILE=$1

    if command -v aws >/dev/null 2>&1
    then
        aws sts get-caller-identity &> /dev/null
        EXIT_CODE="$?"
        if [ $EXIT_CODE != 0 ]; then
            aws sso login $SSO_SESSION_NAME
        fi

        aws configure export-credentials --profile $PROFILE --format env-no-export
    fi

}

# test later
#changeMac(){
#  local mac=$(openssl rand -hex 6 | sed 's/\(..\)/\1:/g; s/.$//')
#  sudo ifconfig en0 ether $mac
#  sudo ifconfig en0 down
#  sudo ifconfig en0 up
#  echo "Your new physical address is $mac"
#
#  #unlimited wi-fi?
#}

##
# EXPORTS
##

# General exports
export NODE_ENV="development"
export PATH="$HOME/.cargo/bin:$PATH"
export EDITOR=vim
export TMPDIR=/tmp

#
# OTHER STUFF
#
flag_file="/tmp/flag_file"
if [ ! -f $flag_file ]
then
  command -v fetch >/dev/null 2>&1 && { fetch; echo ; touch $flag_file ; }
  # only works if informant is installed (installed via AUR)
  command -v informant > /dev/null 2>&1 && { info list --unread; echo; }
fi

#THIS MUST BE AT THE END OF THE FILE FOR SDKMAN TO WORK!!!
export SDKMAN_DIR="$HOME/.sdkman"
if [ ! -f $SDKMAN_DIR/bin/sdkman-init.sh ]; then
   curl -s "https://get.sdkman.io" | bash
   echo "!!!!! ATTENTION !!!!!"
   echo "The sdkman installation adds some reduntant code at .bashrc and .zsh files. Remove this snippets"
fi
[[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && source "$SDKMAN_DIR/bin/sdkman-init.sh"

#
export NVM_DIR="$HOME/.nvm"
if [ ! -f $NVM_DIR/nvm.sh ]; then
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
    echo "!!!!! ATTENTION !!!!!"
    echo "The nvm installation adds some reduntant code at .bashrc and .zsh files. Remove this snippets"
fi
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

if [ ! -f "$HOME/.local/share/../bin/env" ]; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    echo "!!!!! ATTENTION !!!!!"
    echo "The uv/uvx installation adds some reduntant code at .bashrc and .zsh files. Remove this snippets"
fi
. "$HOME/.local/share/../bin/env"
